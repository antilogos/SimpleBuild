<!Doctype html>
<html lang="en-US">
<head>
<!-- TODO -->
<!-- Add check if empty item, passive, gem, etc. -->
<!-- Add check if non-readable or empty pob -->
<!-- Add check everywhere necessary -->
<!-- Add fetch pob url like pastbin, ninja and other -->
<!-- Add support for different skill setups -->
<!-- Add support for different item setups -->
<!-- Add display of class -->
<!-- Horadric Helper -->
<script src="https://cdn.jsdelivr.net/gh/meta-is-beta/horadric-helper@v0.13/dist/poe/horadric-helper-poe.umd.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/meta-is-beta/horadric-helper@v0.13/dist/poe/horadric-helper-poe.css"/>
<!-- Passive Skill Tree parser -->
<script src="TreeParser.js"></script>
<script>
var passiveSkillTreeData, treeNodes, loadPassive = false;
fetch("https://raw.githubusercontent.com/antilogos/SimpleFiltre/master/TreeParser/data-320.json").then(response => response.json()).then(parsed => {
	passiveSkillTreeData = parsed;
	treeNodes = extractNodesData(parsed);
	loadPassive = true;
}).then(data => waitForLoadAsync());
</script>
<!-- External files for mods from RePoE -->
<script src="Repoe.js"></script>
<!-- External data for quest reward from https://poe-roadmap.com/api/gems -->
<script src="GemReward.js"></script>
<!-- Translate pob code into javascript object with pako library to unzip -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
<script src="PobParser.js"></script>
<script>
// Create the all the data for Horadric Helper
var hhData = Array();
function displayMode(elem, type) {
	if(type == "show") {
		elem.setAttribute("as-showcase","");
		elem.setAttribute("icon-inside","");
	} else {
		elem.setAttribute("as-icon","");
		elem.setAttribute("icon-size","md");
	}
}

function conditionToFormat(sentence, cn, statValue) {
	if(sentence.format[cn] !== undefined && sentence.format[cn].contains("ignore")) {
		return "ignore";
	} else if(sentence.format[cn] !== undefined) {
		return sentence.string.replaceAll("\{0\}", sentence.format[cn].replaceAll("#", statValue));
	} else {
		console.log("no format?", sentence,cn);
		return false;
	}
}
function translateStats(gemStat) {
	var skillModifiers = [];
	// TODO regroup value of shared mod id
	//console.log("readable stats:",gemStat);
	gemStat.forEach( (stats, index) => {
		// Assure that translation in specific language exists
		if(stats.translate.English !== undefined) {
			// from each sentence available, only one can be displayed? XXX replace find with filter later to test
			let translation = stats.translate.English.filter( sentence => {
				// check if all condition apply
				return sentence.condition.every( condition => {
					if(condition.hasOwnProperty("min")) {
						if(condition.hasOwnProperty("max")) {
							return condition.min <= stats.value && condition.max >= stats.value;
						} else return condition.min <= stats.value;
					} else if(condition.hasOwnProperty("max")) {
						return condition.max >= stats.value;
					} else if(Object.keys(condition).length === 0) {
						// free match
						return true;
					} else {
						console.log("other condition,",condition,"for",sentence);
						return true;
					}
				})
			})
			// TODO traitement après condition trouvé
			if(translation !== undefined) {
				var baseString, ignore = false;
				// TODO what is index_handlers?
				//conditionToFormat(translation[0], 0, stats.value);
				translation.forEach( sentence => {
					if(sentence.format !== undefined && sentence.format.indexOf("ignore") > 0) {
						ignore = true;
					} else {
						baseString = sentence.string.replaceAll("\{0\}", sentence.format[0].replaceAll("#", stats.value));
					}
				});
				if(baseString !== undefined && !ignore) skillModifiers.push(baseString);
			}
		} else {
			// Mods that are not meant to be displayed?
			// console.log("not found ",statGroup," for ",stats," with file ", skillGem.stat_translation_file);
		}
	});
	//var indexInStat = statGroup.ids.findIndex(id => id == statsDescription[0].id);
	//console.log("find stat",skillModifiers);
	return skillModifiers;
}
// Add items HH applyConfig
function loadItemData(itemGroups) {
  // Items
	itemGroups.items.forEach( k => {
		var config = [];
		config.reference = k.itemId;
		// Remove PoB lines with ModRange and empty lines
		config.data = k.innerText.split("\n").filter(line => line.trim().length > 0 && line.indexOf("ModRange") < 0 && line != "Sockets:").join("\n");
		hhData.push(config);
		//console.log("loaded items");
	});
}
// Add gems HH config
function loadGemData(gemGroups) {
	gemGroups.forEach( (gemGroup, k) => {
		gemGroup.groups.forEach( (s, i) => {
			s.gems.forEach( (g, j) => {
				var config = [], gemData = [], gemSection = [];
				var skillGem = allGem[g.skill];
				var skillModifiers = [];
				if(skillGem.active_skill !== undefined) {
					// Active skill gem
					gemSection.gemDescription = [].concat(skillGem.active_skill.description);
				} else {
					// Support skill gem
					// XXX no gem description for support ?
				}
				var gemStat = [];
				// Parse stats and per level stats to keep only stats that have description with the value of base or appropriate level
				skillGem.static.stats.forEach( (stats, index) => {
					// if stats not displayed from static, it should come from per_level
					if(stats === null) stats = skillGem.per_level[1].stats[index];
					var statTranslation;
					if(skillGem.stat_translation_file !== undefined) statTranslation = mapStatGem[skillGem.stat_translation_file].find(a => a.ids.find(id => id == stats.id));
					else statTranslation = allStats.find(a => a.ids.find(id => id == stats.id));
					if(statTranslation !== undefined) {
						var keyValueStat = {};
						keyValueStat.id = stats.id;
						if(stats.hasOwnProperty("value")) keyValueStat.value = stats.value;
						else if(skillGem.per_level[g.level] && skillGem.per_level[g.level].stats[index] && skillGem.per_level[g.level].stats[index].value)
						keyValueStat.value = skillGem.per_level[g.level].stats[index].value;
						keyValueStat.translate = statTranslation;
						gemStat.push(keyValueStat);
					} else {
						//console.log("translation not found", stats, g[1].getAttribute("skillId"));
					}
				});
				// Include stat from appropriate quality and normalized it with quality value (base on 2000)
				let qualityStat = skillGem.static.quality_stats[qualityIdMap[g.qualityId]];
				if(qualityStat !== undefined) {
					let qualityTranslation = allStats.find(a => a.ids.find(id => id == qualityStat.id));
					if(g.quality !== undefined && g.quality > 0 && qualityTranslation !== undefined) {
						var keyValueStat = {};
						keyValueStat.id = qualityStat.id;
						keyValueStat.value = qualityStat.value / 2000 * g.quality;
						keyValueStat.translate = qualityTranslation;
						gemStat.push(keyValueStat);
					}
					skillModifiers.push(translateStats(gemStat));
				}
				//console.log(skillModifiers);

				if(skillModifiers.length > 0) gemSection.modifiers = skillModifiers.flat();
				gemData.rarity = "Gem";
				if(skillGem.base_item !== null) {
					gemData.name = skillGem.base_item.display_name;
					gemSection.properties = [].concat(skillGem.tags.filter(t => TAG_FILTER.indexOf(t) < 0).join(", "));
				} else {
					gemData.name = skillGem.active_skill.display_name;
					gemSection.properties = [].concat(skillGem.active_skill.types.filter(t => TAG_FILTER.indexOf(t) < 0).join(", "));
				}
				gemData.sections = gemSection;
				config.reference = "gem_" + k + "_" + i + "_" + j;
				config.data = gemData;
				config.iconUrl = "";
				hhData.push(config);
				//console.log("loaded gem", config);
			})
		});
	})
}
// Add passive node HH config
function loadNodeData(treeGroups) {
	for (let treeGroup of treeGroups) {
		treeGroup.nodes.split(",").forEach( (k, i) => {
			let node = treeNodes[k];
			if(node !== undefined && node.isNotable) {
				var nodeData = [], nodeSection = [], config = [];
				var stats = node.stats;
				if(node.reminderText) stats.concat(node.reminderText);
				nodeSection.description = [].concat(stats);
				nodeData.sections = nodeSection;
				nodeData.name = node.name;
				if(node.ascendancyName !== undefined) {
					nodeData.type = "ascendancy notable"
				} else {
					nodeData.type = "notable"
				}
				config.reference = "node_"+k;
				config.data = nodeData;
				config.iconUrl = "";
				hhData.push(config);
				//console.log("loaded passive", config);
			}
		});
		var masteryGroup = new Map();
		treeGroup.masteryEffects.split("},{").forEach( (k, i) => {
			let master = k.split(",")[0].replaceAll("\{","").replaceAll("\}","");
			let slave = k.split(",")[1].replaceAll("\{","").replaceAll("\}","");
			let mastery = treeNodes[master].name;
			let effect = treeNodes[master].masteryEffects.find( e => e.effect == slave);
			if(effect !== undefined) {
				if(masteryGroup[mastery] !== undefined) {
					masteryGroup[mastery] = masteryGroup[mastery].concat(effect.stats);
				}
				else masteryGroup[mastery] = [].concat(effect.stats);
				if(effect.reminderText !== undefined) masteryGroup[mastery] = masteryGroup[mastery].concat(effect.reminderText);
			}
		});
		Object.entries(masteryGroup).forEach( k => {
			var nodeData = [], nodeSection = [], config = [];
			nodeSection.description = [].concat(k[1]);
			nodeData.sections = nodeSection;
			nodeData.name = k[0];
			nodeData.type = "mastery"
			config.reference = "mastery_"+k[0];
			config.data = nodeData;
			config.iconUrl = "";
			hhData.push(config);
			//console.log("loaded mastery", config);
		});
	}
}

// Get items from pob (listed under slots) and create div for each of them
function fillGemProfile(gemGroup, index) {
	clearProfile([DIV_SETUP]);
	// Add poe-item for each gem, each group in a single div
	gemGroup.groups.forEach( (k, i) => {
		var div = document.createElement("div");
		div.setAttribute("id", "gem_"+i);
		k.gems.forEach( (g, j) => {
			var skillGem = allGem[g.skill];
			var gemName;
			if(skillGem.base_item !== null) {
				gemName = skillGem.base_item.display_name;
			} else {
				gemName = skillGem.active_skill.display_name;
			}
			let gemRef = "gem_"+index+"_"+i+"_"+j;
			// Creation of the poe-item html element for HoradricHelper
			var item = document.createElement("poe-item");
			item.setAttribute("reference", gemRef);
			displayMode(item, "popup");
			item.setAttribute("label-text",gemName);
			div.appendChild(item);
		});
		document.getElementById(DIV_SETUP).appendChild(div);
	});
	//TODO link to roadmap
}
function fillTreeProfile(treeGroup) {
	clearProfile([DIV_ASCENDANCY,DIV_KEYSTONE,DIV_MASTERY,DIV_PREVIEW]);
	// Add poe-passive for each ascendancy and keystone allocated
	treeGroup.nodes.split(",").forEach( (k, i) => {
		let node = treeNodes[k];
		if(node !== undefined && (node.isNotable || node.ascendancyName !== undefined || node.isKeystone)) {
			// Creation of the poe-item html element for HoradricHelper
			var item = document.createElement("poe-passive");
			item.setAttribute("reference", "node_"+k);
			displayMode(item, "show");
			item.setAttribute("label-text", node.name);
			// Depending on the type of nodes
			if(node.ascendancyName !== undefined) {
				document.getElementById(DIV_ASCENDANCY).appendChild(item);
			} else if(node.isKeystone) {
				document.getElementById(DIV_KEYSTONE).appendChild(item);
			}
		}
	});
	// Add poe-passive for Masteris group with their effect from all masteries allocated
	var masteryGroup = new Map();
	treeGroup.masteryEffects.split("},{").forEach( (k, i) => {
		let master = k.split(",")[0].replaceAll("\{","").replaceAll("\}","");
		let mastery = treeNodes[master].name;
		masteryGroup[mastery] = master;
	});
	Object.entries(masteryGroup).forEach( k => {
		// Creation of the poe-item html element for HoradricHelper
		var item = document.createElement("poe-passive");
		item.setAttribute("reference", "mastery_"+k[0]);
		displayMode(item, "show");
		item.setAttribute("label-text", k[0]);
		document.getElementById(DIV_MASTERY).appendChild(item);
	});
	// Tree Preview
	buildSvgTree(DIV_PREVIEW, treeNodes);
	buildPath(treeGroup, {"stroke":"#166","width":96}, DIV_PREVIEW, treeNodes, passiveSkillTreeData);
}
function fillProfile(pobObject) {
	console.log(pobObject);
	// Add div for each gems setup and a link to raodmap
	for (let option of pobObject.gemGroups) {
		let optionElement = document.createElement("button");
		optionElement.innerHTML = option.title;
		optionElement.addEventListener('click', function (event) {
			fillGemProfile(option, pobObject.gemGroups.indexOf(option));
		});
		document.getElementById(DIV_ROADMAP).appendChild(optionElement);
	}
	fillGemProfile(pobObject.gemGroups[0], 0);
	// Add poe-item for each equipment, each group in a single div
	pobObject.itemGroups.items.forEach( k => {
		// Creation of the poe-item html element for HoradricHelper
		var item = document.createElement("poe-item");
		item.setAttribute("reference", k.itemId);
		displayMode(item, "show");
		// TODO item.setAttribute("label-text","maybe latter");
		var brotherDiv;
		// Depending on the name of the slot, we put this under different header
		if(k.itemId.startsWith("Jewel")) {
			document.getElementById(DIV_WEAPON).appendChild(item);
		} else if(k.itemId.startsWith("Flask")) {
			document.getElementById(DIV_WEAPON).appendChild(item);
		} else {
			document.getElementById(DIV_WEAPON).appendChild(item);
		}
	})
	
	// Add div for each tree setup and a link to the official tree
	for (let option of pobObject.treeGroups) {
		let optionElement = document.createElement("button");
		optionElement.innerHTML = option.title + " (" + option.nodes.split(",").length + " points)";
		optionElement.addEventListener('click', function (event) {
			fillTreeProfile(option);
		});
		document.getElementById(DIV_TREE).appendChild(optionElement);
	}
	fillTreeProfile(pobObject.treeGroups[0]);

	// Notes
	let notesHeader = document.getElementById(DIV_NOTES);
	let notesDiv = document.createElement("div");
	notesDiv.setAttribute("class", "passive_display");
	notesDiv.id = "notesDiv";
	notesDiv.innerHTML = pobObject.notes.replaceAll("\n","<br/>").replaceAll(/\^x([0-9A-Fa-f]{6})(.*?)\^7/g,"<font color='#$1'>$2</font>").replaceAll(/\^x([0-9A-Fa-f]{6})/g,"").replaceAll(/\^7/g,"");
	notesHeader.insertAdjacentElement("afterend", notesDiv);
	
	loadItemData(pobObject.itemGroups);
	loadNodeData(pobObject.treeGroups);
	loadGemData(pobObject.gemGroups);
	loadHoradricHelper();
}
function loadHoradricHelper() {
	//console.log("launch HH");
	window.HoradricHelper.PathOfExile && window.HoradricHelper.PathOfExile.applyConfig(hhData);
}
function waitForLoadAsync() {
	if(!loadStats || !loadGem || !loadPassive) return;
	else {
		console.log("finish loading");
	}
}
function clearProfile(divList) {
	if(divList == null) divList = [DIV_NOTES, DIV_SETUP, DIV_ROADMAP, DIV_ASCENDANCY, DIV_TREE, DIV_MASTERY, DIV_PREVIEW, DIV_KEYSTONE, DIV_WEAPON];
	for (let divId of divList) {
		let divElement = document.getElementById(divId);
		while(divElement.firstChild) {
			divElement.removeChild(divElement.firstChild);
		}
	}
}
function parseAndLoadCode() {
	var input = document.getElementById("pobinput").value.trim();
	if(input.startsWith("https://pastebin.com")) {
		window.open(input.replaceAll("https://pastebin.com/","https://pastebin.com/raw/"), "_blank");
	} else if(input.startsWith("https://pobb.in")) {
		window.open(input, "_blank");
	} else if(input.startsWith("https://poe.ninja")) {
		window.open(input, "_blank");
	} else {
		// Trying loading input
		var pobObject = pobCodeToObject(input);
		if(pobObject !== undefined) {
			// If valid code, clear before load
			displayMenu('home');
			// Clear old
			clearProfile();
			hhData = [];
			// Load new
			var pobData = loadPobData(pobObject);
			fillProfile(pobData);
		}
	}
}
// ONLOAD
window.onload = function() {
}
</script>
<!-- Navigation and page script -->
<script>
const DIV_NOTES = "notesDiv", DIV_SETUP = "setupDiv", DIV_ROADMAP = "roadmapDiv", 
	DIV_ASCENDANCY = "ascendancyDiv", DIV_TREE = "treeDiv", DIV_MASTERY = "masteryDiv", DIV_PREVIEW = "previewDiv", DIV_KEYSTONE = "keystoneDiv",
	DIV_WEAPON = "weaponDiv";
const TAG_FILTER = ["active_skill", "dexterity", "intelligence", "strength"];

function displayMenu(page) {
  document.getElementById("page_display").style.display = (page == "home") ? "block" : "none";
  document.getElementById("page_import").style.display = (page == "import") ? "block" : "none";
  //document.getElementById("page_display").style.display = (page == "home") ? "block" : "none";
  //document.getElementById("page_display").style.display = (page == "home") ? "block" : "none";
  //document.getElementById("page_display").style.display = (page == "home") ? "block" : "none";
  //document.getElementById("page_display").style.display = (page == "home") ? "block" : "none";
}
function selectStyle(theme) {
  document.body.classList = "";
  document.body.classList.add(theme);
}
</script>
<!-- Style -->
<link rel="stylesheet" href="style.css">
</head>
<!-- Body -->
<body class="dark">
<div class="navigation_bar">
  <div class="navigation_home">
    <nav>
      <ul>
        <li><button id="home" onclick="displayMenu('home');">Accueil</button></li>
        <li><button id="import" onclick="displayMenu('import');">Importer</button></li>
        <li id="menu_config"><button onclick="displayMenu('config');">Options</button>
          <ul class="dropmenu">
            <li>
              <div style="display: inline; margin-left: 1em;">Mode&nbsp;<button onclick="selectStyle('dark');">&#9790;</button><button onclick="selectStyle('light');">&#9728;</button>
              </div>
            </li>
          </ul>
        </li>
      </ul>
    </nav>
  </div>
  <div class="navigation_menu">
    <nav>
      <ul>
        <li id="menu_stream"><button>Streameur<span class="arrow"></span></button>
          <ul class="dropmenu">
            <li><button id="touff" onclick="displayMenu('touff');">Touffeless</button></li>
            <li><button id="fifu" onclick="displayMenu('fifu');">Fifu</button></li>
          </ul>
        </li>
        <li id="menu_first"><button>1<sup>er</sup> perso<span class="arrow"></span></button>
          <ul class="dropmenu">
            <li><button id="menu_first_necromancer" onclick="displayMenu('necromancer');">Nécromancienne</button></li>
            <li><button id="menu_first_occultist" onclick="displayMenu('occultist');">Occultist</button></li>
            <li><button id="menu_first_elementalist" onclick="displayMenu('elementalist');">Élémentaliste</button></li>
            <li><button id="menu_first_trickster" onclick="displayMenu('trickster');">Roublard</button></li>
            <li><button id="menu_first_saboteur" onclick="displayMenu('saboteur');">Saboteur</button></li>
            <li><button id="menu_first_assassin" onclick="displayMenu('assassin');">Assassin</button></li>
            <li><button id="menu_first_raider" onclick="displayMenu('raider');">Furie</button></li>
            <li><button id="menu_first_pathfinder" onclick="displayMenu('pathfinder');">Éclaireuse</button></li>
            <li><button id="menu_first_deadeye" onclick="displayMenu('deadeye');">Archère d'élite</button></li>
            <li><button id="menu_first_champion" onclick="displayMenu('champion');">Champion</button></li>
            <li><button id="menu_first_slayer" onclick="displayMenu('slayer');">Sanguinaire</button></li>
            <li><button id="menu_first_gladiator" onclick="displayMenu('gladiator');">Gladiateur</button></li>
            <li><button id="menu_first_juggernaut" onclick="displayMenu('juggernaut');">Colosse</button></li>
            <li><button id="menu_first_berserker" onclick="displayMenu('berserker');">Berserker</button></li>
            <li><button id="menu_first_chieftain" onclick="displayMenu('chieftain');">Chef tribal</button></li>
            <li><button id="menu_first_inquisitor" onclick="displayMenu('inquisitor');">Inquisiteur</button></li>
            <li><button id="menu_first_hierophant" onclick="displayMenu('hierophant');">Hiérophant</button></li>
            <li><button id="menu_first_guardian" onclick="displayMenu('guardian');">Guardien</button></li>
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</div>
<!-- Import Page -->
<div class="page" id="page_import">
<h1>Import</h1>
<label>POB code:</label>
<input type="text" id="pobinput" size=100 />
<button type="submit" onclick="parseAndLoadCode();">submit</button>
</div>
<!-- Display Page -->
<div class="page" id="page_display">
<h1 id="notes">Concept</h1>
<div class="section">
	<div class="filling" id="notesDiv"></div>
</div>
<h1>Gemmes</h1>
<div class="section">
	<div style="width: auto">
		<h2>Groupes</h2>
		<div id="setupDiv"></div>
	</div>
	<div style="max-width: 40%">
		<h2>Configurations</h2>
		<div id="roadmapDiv"></div>
	</div>
</div>
<h1>Talents passifs</h1>
<div class="section">
	<div style="width: auto">
		<h2>Prévisualisation<h2>
		<div id="previewDiv"></div>
	</div>
	<div style="display: block; max-width: 30%">
		<div>
			<h2>Arbres</h2>
			<div id="treeDiv"></div>
		</div>
		<div>
			<h2>Ascendance</h2>
			<div id="ascendancyDiv"></div>
		</div>
		<div>
			<h2>Maîtrises</h2>
			<div id="masteryDiv"></div>
		</div>
		<div>
			<h2>Charnières</h2>
			<div id="keystoneDiv"></div>
		</div>
	</div>
</div>
<!--h2 id="pantheon">Bandits & Pantheon</h2-->
<h1>Objets</h1>
<div class="section">
	<div style="width: auto">
		<h2>Armes</h2>
		<div id="weaponDiv"></div>
	</div>
	<div>
		<h2>Torse</h2>
		<div />
	</div>
	<div>
		<h2>Casque</h2>
		<div />
	</div>
	<div>
		<h2>Gants</h2>
		<div />
	</div>
	<div>
		<h2>Bottes</h2>
		<div />
	</div>
	<div>
		<h2>Accessoires</h2>
		<div />
	</div>
	<div>
		<h2>Flacons</h2>
		<div />
	</div>
	<div>
		<h2>Joyaux</h2>
		<div />
	</div>
</div>
</div>
<!-- Other Page? -->
</body>
</html>
